

# ğŸ Python ç²¾ç°¡æ•™å­¸ï¼šç”¨ `jsonpickle` å„²å­˜èˆ‡é‚„åŸå¤šå‹ç‰©ä»¶ï¼

åœ¨ Python ä¸­ï¼Œæˆ‘å€‘å¸¸éœ€è¦æŠŠè‡ªè¨‚ç‰©ä»¶è½‰æˆ JSON å„²å­˜æˆ–å‚³è¼¸ã€‚ä¸éæ¨™æº–çš„ `json` æ¨¡çµ„åªèƒ½è™•ç† dictã€listã€strã€int ç­‰åŸºæœ¬å‹åˆ¥ï¼Œé‡åˆ°é¡åˆ¥ï¼ˆå°¤å…¶æ˜¯å¤šå‹ï¼‰æ™‚å°± GG ğŸ˜µã€‚

é€™æ™‚å€™ï¼Œ**`jsonpickle` å°±æ˜¯ä½ çš„å¥½å¹«æ‰‹**ï¼

---

## âœ… `jsonpickle` æ˜¯ä»€éº¼ï¼Ÿ

`jsonpickle` æ˜¯ä¸€å€‹ Python å¥—ä»¶ï¼Œå¯ä»¥å°‡ **ä»»æ„ Python ç‰©ä»¶ï¼ˆåŒ…å«é¡åˆ¥ã€å·¢ç‹€ã€å¤šå‹ï¼‰åºåˆ—åŒ–æˆ JSON**ï¼Œä¸¦æ”¯æ´é‚„åŸã€‚

å®ƒçš„æ•ˆæœå¾ˆåƒ Java çš„ `@JsonTypeInfo(use = CLASS)` æˆ– Python çš„ `pickle`ï¼Œä½†æ˜¯ JSON æ ¼å¼ï¼Œæ›´é€šç”¨ï¼

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹ï¼šä¸€åˆ†é˜ææ‡‚ `jsonpickle`

### âœ¨ å®‰è£

```bash
pip install jsonpickle
```

---

### ğŸ¶ å‡è¨­æˆ‘å€‘æœ‰ä»¥ä¸‹é¡åˆ¥çµæ§‹ï¼š

```python
class Animal:
    def __init__(self, name):
        self.name = name

class Dog(Animal):
    def __init__(self, name, bark=True):
        super().__init__(name)
        self.bark = bark
```

---

### ğŸ” åºåˆ—åŒ– + ååºåˆ—åŒ–

```python
import jsonpickle

dog = Dog("Buddy")

# åºåˆ—åŒ–æˆ JSON å­—ä¸²
json_str = jsonpickle.encode(dog)
print(json_str)

# ååºåˆ—åŒ–å›åŸæœ¬çš„ Dog ç‰©ä»¶
obj = jsonpickle.decode(json_str)
print(type(obj), obj.__dict__)
```

---

### ğŸ“¦ è¼¸å‡º JSON ç¯„ä¾‹

```json
{
  "py/object": "__main__.Dog",
  "name": "Buddy",
  "bark": true
}
```

é€™è£¡çš„ `"py/object"` å°±æ˜¯é¡ä¼¼ Java çš„ `"@class"`ï¼Œè‡ªå‹•åŒ…å«å®Œæ•´é¡å‹è³‡è¨Šï¼Œé‚„åŸæ™‚æœƒç”¨ `import` æ–¹å¼å‹•æ…‹è¼‰å…¥é¡åˆ¥ã€‚

---

## ğŸ§  ä½¿ç”¨æƒ…å¢ƒ

|ä½¿ç”¨å ´æ™¯|æ˜¯å¦é©åˆ|
|---|---|
|å„²å­˜/é‚„åŸå‹•æ…‹å‹åˆ¥è³‡æ–™|âœ… éå¸¸é©åˆ|
|åºåˆ—åŒ–å·¢ç‹€è³‡æ–™æˆ–å¾ªç’°å¼•ç”¨|âœ… è™•ç†å¾—å¾ˆå¥½|
|è·¨èªè¨€ï¼ˆé€ JSON çµ¦å‰ç«¯ï¼‰|âŒ ä¸æ¨è–¦ï¼Œæ ¼å¼å¤ªç‰¹æ®Š|
|é«˜å®‰å…¨æ€§å ´æ™¯ï¼ˆæ¥å—ç”¨æˆ¶è¼¸å…¥ï¼‰|âš ï¸ è¬¹æ…ä½¿ç”¨ï¼Œå‹¿ decode ä¸å¯ä¿¡ JSON|

---

## ğŸ›¡ï¸ å®‰å…¨æé†’ï¼

å› ç‚º `jsonpickle.decode()` æœƒä¾ç…§ `py/object` å‹•æ…‹å»ºç«‹é¡åˆ¥å¯¦ä¾‹ï¼Œ**åƒè¬ä¸è¦ç”¨ä¾†ååºåˆ—åŒ–ä¸å¯ä¿¡ä¾†æºçš„ JSON**ï¼

å¦‚éœ€èˆ‡å¤–éƒ¨ç³»çµ±äº’å‹•ï¼Œå»ºè­°ä½¿ç”¨ `dict()` + `json` æ‰‹å‹•åºåˆ—åŒ–æˆ–ç”¨ `pydantic`ã€‚

---

## ğŸ çµèª

|ä½ è¦çš„åŠŸèƒ½|ç”¨ `jsonpickle` âœ…|
|---|---|
|åºåˆ—åŒ–/ååºåˆ—åŒ–è‡ªè¨‚é¡åˆ¥|âœ…|
|ä¿ç•™é¡å‹è³‡è¨Š|âœ… è‡ªå‹•åŠ  `"py/object"`|
|å¿«é€Ÿé‚„åŸ Python å¤šå‹ç‰©ä»¶|âœ… ä¸€è¡Œæå®š|

ç°¡å–®ä¸€å¥è©±ï¼š**jsonpickle æ˜¯ Python ç‰ˆçš„ `@JsonTypeInfo(use = CLASS)`ï¼Œè¶…é©åˆè™•ç†å¤šå‹ã€å·¢ç‹€èˆ‡é¡åˆ¥å°è£ç‰©ä»¶ï¼**


# ğŸ“jsonpickle èˆ‡ @dataclass äº¤äº’è¡Œç‚º

## 1. æ ¸å¿ƒæ¦‚å¿µ

- **Dataclass**ï¼šè² è²¬å®šç¾©è³‡æ–™çµæ§‹ï¼ˆSchemaï¼‰ï¼Œç°¡åŒ–é¡åˆ¥å®£å‘Šã€‚
    
- **jsonpickle**ï¼šè² è²¬ç‰©ä»¶åºåˆ—åŒ–ï¼ˆSerializationï¼‰ï¼Œå°‡ Python ç‰©ä»¶è½‰ç‚º JSON å­—ä¸²ï¼Œä¸¦èƒ½å®Œæ•´é‚„åŸï¼ˆåŒ…å«é¡åˆ¥è³‡è¨Šï¼‰ã€‚
    
- **äº¤äº’çµè«–**ï¼šå…©è€…**åŸç”Ÿç›¸å®¹**ï¼Œç„¡éœ€é¡å¤–é…ç½®ã€‚`jsonpickle` é‡å° `dataclass` çš„ç‰¹æ®Šæ¬„ä½ï¼ˆå¦‚ `init=False`ï¼‰ä¹Ÿèƒ½æ­£ç¢ºè™•ç†ã€‚
    

## 2. é—œéµè¡Œç‚ºæ¸¬è©¦

### æ¸¬è©¦å ´æ™¯

æˆ‘å€‘å®šç¾©ä¸€å€‹åŒ…å«ä»¥ä¸‹ç‰¹æ€§çš„ Dataclassï¼š

1. **ä¸€èˆ¬æ¬„ä½**ï¼š`id`, `name`
    
2. **`default_factory`**ï¼š`tags` (é è¨­ç‚ºç©º list)
    
3. **`init=False`**ï¼š`created_at` (ä¸é€é init å‚³å…¥ï¼Œè€Œæ˜¯å…§éƒ¨ç”¢ç”Ÿ)
    


```Python
import jsonpickle
from dataclasses import dataclass, field
from datetime import datetime
import time

@dataclass
class Task:
    id: int
    name: str
    
    # ç‰¹æ€§ A: default_factory (é è¨­å€¼å·¥å» )
    tags: list[str] = field(default_factory=list)
    
    # ç‰¹æ€§ B: init=False (éå»ºæ§‹å­åƒæ•¸ï¼Œé€šå¸¸ç”± __post_init__ ç”¢ç”Ÿ)
    created_at: float = field(init=False)

    def __post_init__(self):
        self.created_at = time.time()

# --- 1. å»ºç«‹ç‰©ä»¶ ---
task = Task(id=1, name="Data Cleanup")
task.tags.append("urgent")
#æ­¤æ™‚ task.created_at å·²ç¶“ç”± __post_init__ è‡ªå‹•ç”Ÿæˆ
print(f"åŸå§‹ç‰©ä»¶: {task}")

# --- 2. åºåˆ—åŒ– (Encode) ---
json_str = jsonpickle.encode(task, indent=2)
print(f"\nJSON (å„²å­˜ç‹€æ…‹):\n{json_str}")

# --- 3. ååºåˆ—åŒ– (Decode) ---
restored_task = jsonpickle.decode(json_str)
print(f"\né‚„åŸç‰©ä»¶: {restored_task}")
```

### è§€å¯Ÿçµæœ

JSON è¼¸å‡ºæœƒåŒ…å«æ‰€æœ‰æ¬„ä½ï¼ŒåŒ…æ‹¬ `init=False` çš„æ¬„ä½ï¼š



```JSON
{
  "py/object": "__main__.Task",
  "id": 1,
  "name": "Data Cleanup",
  "tags": ["urgent"],
  "created_at": 1708320000.123  <-- ç‹€æ…‹è¢«å®Œæ•´ä¿å­˜
}
```

---

## 3. é‡è¦æ©Ÿåˆ¶è©³è§£ (The "Gotchas")

### Q1: `field(init=False)` çš„æ¬„ä½æœƒè¢«å„²å­˜å—ï¼Ÿ

- **ç­”æ¡ˆï¼šæœƒã€‚**
    
- **åŸå› **ï¼š`jsonpickle` åºåˆ—åŒ–çš„æ˜¯ **"ç‰©ä»¶ç•¶ä¸‹çš„ç‹€æ…‹" (`__dict__`)**ï¼Œè€Œä¸æ˜¯ **"å»ºæ§‹å‡½å¼çš„åƒæ•¸"**ã€‚åªè¦è©²æ¬„ä½åœ¨ç‰©ä»¶ä¸­å­˜åœ¨ï¼ˆå³ä½¿æ˜¯åœ¨ `__post_init__` ä¸­è³¦å€¼çš„ï¼‰ï¼Œå°±æœƒè¢«å­˜ä¸‹ä¾†ã€‚
    

### Q2: ååºåˆ—åŒ–æ™‚ï¼Œæœƒé‡æ–°åŸ·è¡Œ `__init__` æˆ– `__post_init__` å—ï¼Ÿ

- **ç­”æ¡ˆï¼šä¸æœƒã€‚** (é€™æ˜¯æœ€é‡è¦çš„è§€å¿µ)
    
- **æ©Ÿåˆ¶**ï¼š`jsonpickle` é‚„åŸç‰©ä»¶æ™‚ï¼Œæ˜¯å‰µå»ºä¸€å€‹ç©ºç‰©ä»¶ï¼Œç„¶å¾Œå°‡ JSON è£¡çš„æ•¸å€¼ç›´æ¥å¡«å…¥ `__dict__`ã€‚
    
- **å½±éŸ¿**ï¼š
    
    - å¦‚æœä½ çš„ `created_at` æ˜¯é€é `time.time()` åœ¨ `__post_init__` ç”Ÿæˆçš„ï¼Œ**é‚„åŸæ™‚ä¸æœƒè®Šæˆç¾åœ¨çš„æ™‚é–“**ï¼Œè€Œæ˜¯ä¿æŒ **"ç•¶åˆå„²å­˜æ™‚çš„æ™‚é–“"**ã€‚
        
    - é€™ä¿è­‰äº†è³‡æ–™çš„ä¸€è‡´æ€§ï¼ˆSnapshotï¼‰ã€‚
        

### Q3: `default_factory` çš„è¡Œç‚ºï¼Ÿ

- **ç­”æ¡ˆï¼šæ­£å¸¸é‹ä½œã€‚**
    
- ç‰©ä»¶å»ºç«‹æ™‚ï¼ŒList è¢«åˆå§‹åŒ–ã€‚åºåˆ—åŒ–æ™‚ï¼ŒList è£¡çš„å…§å®¹ï¼ˆä¾‹å¦‚ `['urgent']`ï¼‰è¢«å­˜å…¥ JSONã€‚é‚„åŸæ™‚ï¼Œé€™äº›å…§å®¹ç›´æ¥è¢«è®€å›ä¾†ã€‚
    

---

## 4. æœ€ä½³å¯¦è¸å»ºè­°

1. **é©åˆå ´æ™¯**ï¼š
    
    - **è¤‡é›œè¨­å®šæª”**ï¼šä¾‹å¦‚ä½ çš„ ETL Flow è¨­å®šï¼ŒåŒ…å«å·¢ç‹€çµæ§‹ã€‚
        
    - **æš«å­˜/å¿«å– (Caching)**ï¼šå°‡ç‰©ä»¶ç‹€æ…‹å­˜å…¥ Redis æˆ–æª”æ¡ˆï¼Œç¨å¾Œè®€å–ç¹¼çºŒåŸ·è¡Œã€‚
        
    - **é™¤éŒ¯ (Debugging)**ï¼šå°‡å‡ºéŒ¯çš„ç‰©ä»¶ Dump ä¸‹ä¾†åˆ†æã€‚
        
2. **ä¸é©åˆå ´æ™¯**ï¼š
    
    - **è·¨èªè¨€å‚³è¼¸**ï¼šå› ç‚º JSON ä¸­åŒ…å« Python ç‰¹æœ‰çš„ `py/object` æ¨™ç±¤ï¼ŒJava æˆ– JS è®€å–æ™‚æœƒè¦ºå¾—æ€ªæ€ªçš„ï¼ˆé›–ç„¶å¯ä»¥è¨­ `unpicklable=False` ä¾†æ‹¿æ‰æ¨™ç±¤ï¼Œä½†å°±ç„¡æ³•è‡ªå‹•é‚„åŸå›ç‰©ä»¶äº†ï¼‰ã€‚
        
3. **å®‰å…¨æ€§æé†’**ï¼š
    
    - æ°¸é ä¸è¦å° **ä¸å¯ä¿¡ä¾†æº** çš„ JSON å­—ä¸²åŸ·è¡Œ `jsonpickle.decode()`ï¼Œé€™èˆ‡ `pickle` æ¨¡çµ„æœ‰ç›¸åŒçš„å®‰å…¨é¢¨éšªï¼ˆå¯èƒ½å°è‡´æƒ¡æ„ç¨‹å¼ç¢¼åŸ·è¡Œï¼‰ã€‚
        

## 5. ç¸½çµåœ–è¡¨

|**Dataclass ç‰¹æ€§**|**jsonpickle è¡Œç‚º**|**å‚™è¨»**|
|---|---|---|
|ä¸€èˆ¬æ¬„ä½|âœ… ä¿å­˜ & é‚„åŸ|æœ€åŸºæœ¬åŠŸèƒ½|
|`field(default=...)`|âœ… ä¿å­˜ & é‚„åŸ|å¦‚æœå€¼èˆ‡é è¨­å€¼ä¸åŒï¼Œå­˜ç•¶ä¸‹çš„å€¼|
|`field(default_factory=...)`|âœ… ä¿å­˜ & é‚„åŸ|List/Dict å…§å®¹æœƒè¢«å®Œæ•´ä¿ç•™|
|`field(init=False)`|âœ… ä¿å­˜ & é‚„åŸ|**é—œéµ**ï¼šé‚„åŸæ™‚ä¸é‡æ–°è¨ˆç®—ï¼Œä¿ç•™æœ€å¾Œç‹€æ…‹|
|`ClassVar`|âŒ å¿½ç•¥|å±¬æ–¼é¡åˆ¥å±¬æ€§ï¼Œä¸å±¬æ–¼å¯¦ä¾‹ç‹€æ…‹|